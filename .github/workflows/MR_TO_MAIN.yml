name: Merge To Main

on:
  pull_request:
    branches:
      - main

env:
  TEST_GCP_PROJECT: ${{ vars.IM_TEST_PROJECT_ID }}
  TEST_FIREBASE_PROJECT: ${{ vars.IM_TEST_PROJECT_ID }}
  NODE_VERSION: 22.13.0
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  

jobs:
  # ===== MIGRATION PIPELINE (Pre-Deployment) =====
  
  check-pending-migrations:
    name: üîç Check for Pending Migrations
    runs-on: ubuntu-latest
    environment: Test-Database-NoApproval
    env:
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_NAME: ${{ secrets.DB_NAME }}
    outputs:
      pending-migrations: ${{ steps.check-pending.outputs.pending-migrations }}
    steps:
      - uses: actions/checkout@v3
      
      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Install dependencies
        run: npm ci

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Setup Cloud SQL Proxy
        run: |
          # Download Cloud SQL Proxy v2
          curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.18.0/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy
          
          # Start proxy in background
          ./cloud-sql-proxy --port 5432 im-test-395400:us-central1:im-test

      - name: Check for pending migrations
        id: check-pending
        run: |
          npx ts-node --project ./util/tsconfig.json ./util/check_for_pending_migrations.ts


  review-pending-migrations:
    name: üîç Review Pending Migrations (MANUAL)
    runs-on: ubuntu-latest
    environment: Test-Database-Approval
    env:
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_NAME: ${{ secrets.DB_NAME }}
    needs: check-pending-migrations
    if: needs.check-pending-migrations.outputs.pending-migrations == 'true'
    steps:
      - uses: actions/checkout@v3
      
      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Install dependencies
        run: npm ci
      
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Cloud SQL Proxy
        run: |
          # Download Cloud SQL Proxy v2
          curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.18.0/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy
          
          # Start proxy in background
          ./cloud-sql-proxy --port 5432 ${{ vars.IM_TEST_PROJECT_ID }}:us-central1:involvemint &
          
          # Wait for proxy to be ready
          sleep 5

      - name: Show pending migrations
        id: show-migrations
        run: |
          echo "üìã PENDING MIGRATIONS PREVIEW:"
          echo ""
          npx typeorm migration:show -f util/ormconfig.js || echo "Unable to show migrations - will be visible during application"
          echo ""
          echo "üìÅ Migration files to be applied:"
          ls -la libs/migration/*.ts 2>/dev/null || echo "No migration files found in libs/migration/"
      
      - name: Pending migration review required
        run: |
          echo "üîç PENDING MIGRATIONS DETECTED"
          echo ""
          echo "‚ö†Ô∏è There are unapplied migrations in the database."
          echo ""
          echo "Please verify:"
          echo "- Review the pending migration files listed above"
          echo "- Ensure migrations are safe to apply"
          echo "- Confirm no data loss will occur"
          echo "- Check migration preview output above"
          echo ""
          echo "‚úÖ Approve to proceed with applying pending migrations."
          echo ""

  apply-pending-migrations:
    name: ‚öôÔ∏è Apply Pending Migrations
    runs-on: ubuntu-latest
    needs: [check-pending-migrations, review-pending-migrations]
    environment: Test-Database-NoApproval
    env:
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_NAME: ${{ secrets.DB_NAME }}
    if: needs.check-pending-migrations.outputs.pending-migrations == 'true' && (needs.review-pending-migrations.result == 'success' )
    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install dependencies
        run: npm ci
      
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Cloud SQL Proxy
        run: |
          # Download Cloud SQL Proxy v2
          curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.18.0/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy
          
          # Start proxy in background
          ./cloud-sql-proxy --port 5432 ${{ vars.IM_TEST_PROJECT_ID }}:us-central1:involvemint &
          
          # Wait for proxy to be ready
          sleep 5

      - name: Create database backup
        run: |
          echo "üì¶ Creating database backup..."
          PGPASSWORD="$DB_PASSWORD" pg_dump -h "$DB_HOST" -U "$DB_USER" -p "$DB_PORT" -Fc "$DB_NAME" > db_backup_pending_$(date +%Y%m%d_%H%M%S).dump
          echo "‚úÖ Database backup created"
      - name: Apply pending migrations
        run: |
          echo "‚öôÔ∏è Applying pending migrations..."
          npx typeorm migration:run -f util/ormconfig.js
          echo "‚úÖ Pending migrations applied successfully"

  check-schema-drift:
    name: üîç Check for Schema Drift
    runs-on: ubuntu-latest
    needs: [check-pending-migrations, apply-pending-migrations]
    environment: Test-Database-NoApproval
    env:
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_NAME: ${{ secrets.DB_NAME }}
    if: (needs.apply-pending-migrations.result == 'success' || needs.apply-pending-migrations.result == 'skipped')
    outputs:
      migration-needed: ${{ steps.check-drift.outputs.migration-needed }}
    steps:
      - uses: actions/checkout@v3
      
      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Install dependencies
        run: npm ci
      
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Cloud SQL Proxy
        run: |
          # Download Cloud SQL Proxy v2
          curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.18.0/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy
          
          # Start proxy in background
          ./cloud-sql-proxy --port 5432 ${{ vars.IM_TEST_PROJECT_ID }}:us-central1:involvemint &
          
          # Wait for proxy to be ready
          sleep 5

      - name: Check for schema drift
        id: check-drift
        run: |
          npx ts-node --project ./util/tsconfig.json detect_db_entity_drift.ts > ./drift.log
          if grep -q 'MIGRATION_NEEDED=true' drift.log; then
            echo "migration-needed=true" >> $GITHUB_OUTPUT
            echo "üìà Schema drift detected - new migration needed"
          else
            echo "migration-needed=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No schema drift detected"
          fi

  review-new-migration:
    name: üîç Review New Migration (MANUAL)
    runs-on: ubuntu-latest
    environment: Test-Database-Approval
    env:
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_NAME: ${{ secrets.DB_NAME }}
    needs: [check-schema-drift]
    if: needs.check-schema-drift.outputs.migration-needed == 'true' && true
    steps:
      - uses: actions/checkout@v3
      
      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Install dependencies
        run: npm ci

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Setup Cloud SQL Proxy
        run: |
          # Download Cloud SQL Proxy v2
          curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.18.0/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy
          
          # Start proxy in background
          ./cloud-sql-proxy --port 5432 ${{ vars.IM_TEST_PROJECT_ID }}:us-central1:involvemint &
          
          # Wait for proxy to be ready
          sleep 5

      - name: Preview new migration
        id: preview-migration
        run: |
          echo "üìã NEW MIGRATION PREVIEW:"
          echo ""
          echo "üîÑ Generating migration preview (dry-run)..."
          npx typeorm migration:generate -f util/ormconfig.js -n PreviewMigration-$(date +%Y%m%d%H%M%S) --pretty --dry-run 2>/dev/null || {
            echo "‚ö†Ô∏è TypeORM dry-run not supported, generating actual migration for preview..."
            npx typeorm migration:generate -f util/ormconfig.js -n PreviewMigration-$(date +%Y%m%d%H%M%S) --pretty
            echo ""
            echo "üìÅ Generated migration preview:"
            ls -la libs/migration/*PreviewMigration*.ts 2>/dev/null | tail -1
            echo ""
            echo "üìÑ Migration content:"
            cat $(ls -t libs/migration/*PreviewMigration*.ts 2>/dev/null | head -1) || echo "Unable to display migration content"
            echo ""
            echo "üóëÔ∏è Cleaning up preview migration..."
            rm -f libs/migration/*PreviewMigration*.ts
          }
      
      - name: New migration review required
        run: |
          echo "üîç NEW MIGRATION REQUIRED"
          echo ""
          echo "üìà Schema changes detected that require a new migration."
          echo ""
          echo "Please verify:"
          echo "- Review the migration preview shown above"
          echo "- Ensure the generated SQL is safe to apply"
          echo "- Confirm no data loss will occur"
          echo "- Check that indexes and constraints are properly handled"
          echo ""
          echo "After approval, the system will:"
          echo "- Generate a new migration file"
          echo "- Commit it to this PR"
          echo "- Apply the migration to the database"
          echo ""
          echo "‚úÖ Approve to proceed with generating and applying the new migration."
          echo ""

  generate-and-apply-migration:
    name: ‚öôÔ∏è Generate & Apply New Migration
    runs-on: ubuntu-latest
    environment: Test-Database-NoApproval
    env:
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_NAME: ${{ secrets.DB_NAME }}
    needs: [check-schema-drift, review-new-migration]
    if: needs.check-schema-drift.outputs.migration-needed == 'true' && (needs.review-new-migration.result == 'success' )
    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install dependencies
        run: npm ci
      
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Cloud SQL Proxy
        run: |
          # Download Cloud SQL Proxy v2
          curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.18.0/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy
          
          # Start proxy in background
          ./cloud-sql-proxy --port 5432 ${{ vars.IM_TEST_PROJECT_ID }}:us-central1:involvemint &
          
          # Wait for proxy to be ready
          sleep 5

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:$GITHUB_TOKEN@github.com/${{ github.repository }}
      - name: Create database backup (if not already done)
        run: |
          echo "üì¶ Creating database backup for new migration..."
          PGPASSWORD="$DB_PASSWORD" pg_dump -h "$DB_HOST" -U "$DB_USER" -p "$DB_PORT" -Fc "$DB_NAME" > db_backup_new_$(date +%Y%m%d_%H%M%S).dump
          echo "‚úÖ Database backup created"
      - name: Generate and apply migration
        run: |
          echo "üîÑ Generating new migration..."
          npx typeorm migration:generate -f util/ormconfig.js -n AutoMigration-$(date +%Y%m%d%H%M%S) --pretty
          
          echo "üíæ Committing generated migration..."
          git add libs/migration/*.ts
          git commit -m "chore: auto-generated migration - approved ü§ñ This migration was automatically generated and approved. Generated and applied at: $(date -u)"
          git push origin HEAD
          
          echo "‚öôÔ∏è Applying new migration..."
          npx typeorm migration:run -f util/ormconfig.js
          echo "‚úÖ New migration applied successfully"

  deploy-test:
    name: ‚ñ∂Ô∏è Deploy ‚Üí Test (MANUAL)
    environment: Test
    runs-on: ubuntu-latest
    needs: [check-pending-migrations, apply-pending-migrations, check-schema-drift, generate-and-apply-migration]
    if: (needs.apply-pending-migrations.result == 'success' || needs.apply-pending-migrations.result == 'skipped') && (needs.generate-and-apply-migration.result == 'success' || needs.generate-and-apply-migration.result == 'skipped')
    concurrency:
      group: test-environment
      # allow only one "waiting for approval" + "running" job in that group
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Determine new version name
        id: get-version
        run: |
          TAG=${GITHUB_REF#refs/}
          TAG=${TAG#merge}
          SHORT_SHA=${GITHUB_SHA:0:7}
          V="${TAG,,}-${SHORT_SHA}"
          V=${V//[^a-z0-9-]/-}
          echo $V
          echo "NEW_VERSION=${V}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Install dependencies
        run: npm ci

      - name: Install nx@12.3.6
        run: npm install -g nx@12.3.6

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Generate API Environment (test)
        run: npx ts-node ./util/generate_environment.ts generate test
        env:
          INVOLVEMINT_SETTINGS: ${{ secrets.INVOLVEMINT_TEST_SETTINGS_SERVER }}

      - name: Build API (test)
        run: |
          export NODE_OPTIONS=--openssl-legacy-provider
          nx run-many --target=build --projects=api,involvemint --configuration=test --skip-nx-cache

      - name: üöÄ Deploy API to App Engine (Test)
        id: deploy-api
        run: |
          # sanitize
          gcloud config set project ${{ env.TEST_GCP_PROJECT }}
          gcloud app deploy app.yaml \
            --stop-previous-version \
            --quiet \
            --version=${{ steps.get-version.outputs.NEW_VERSION }}

      - name: Delete API Environment (test)
        run: npx ts-node ./util/generate_environment.ts delete test
      
      - name: Generate Client Environment (test)
        run: npx ts-node ./util/generate_environment.ts generate test
        env:
          INVOLVEMINT_SETTINGS: ${{ secrets.INVOLVEMINT_TEST_SETTINGS_CLIENT }}
      
      - name: Build Client (test)
        run: |
          export NODE_OPTIONS=--openssl-legacy-provider
          nx run-many --target=build --projects=involvemint --configuration=test --skip-nx-cache

      - name: Install firebase-tools@13.29.0
        run: npm install -g firebase-tools@13.29.0

      - name: üöÄ Deploy Client to Firebase
        run: |
          firebase use ${{ env.TEST_FIREBASE_PROJECT }}
          firebase deploy --message "${{ steps.get-version.outputs.NEW_VERSION }}"

      - name: Roll back to previous version on failure
        if: ${{ failure() && steps.deploy-api.outcome == 'success' }}
        run: |
          # 1) List the last two deployed versions (sorted by creation time)
          PREV=$(gcloud app versions list \
            --service=default \
            --format="value(version.id)" \
            --sort-by="~version.createTime" \
            --limit=2 \
          )
          # 2) The first returned is the NEW (failed) version; the second is the one before it.
          #    So split on newline, take the second line.
          PREV_VERSION=$(echo "$PREV" | sed -n '2p')

          if [[ -z "$PREV_VERSION" ]]; then
            echo "‚ùå No previous version found to roll back to."
            exit 1
          fi

          echo "üîÑ Rolling back to version: $PREV_VERSION"
          gcloud app services set-traffic default \
            --splits="$PREV_VERSION=1" \
            --quiet
        shell: bash

  test-env-verified:
    name: ‚úÖ Approve Test Env Validation (MANUAL)
    environment: Test
    runs-on: ubuntu-latest
    needs: deploy-test
    steps:
      - run: echo "Testing in TEST environment has been completed, approved by."



